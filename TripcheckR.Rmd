---
title: "Predicting Santiam Pass Safety using Twitter"
author: "Winston Saunders"
date: "November 2014"
output: html_document
---

###Summary

The [Oregon Dept of Transportation](https://tripcheck.com/Pages/Twitter.asp) regularly publishes, as a public service, live road reports via Twitter. The record created by these tweets can be used to recontruct the times and locations of accidents on sections of road and also to correlate them with road conditions.  

This analysis is useful to drivers since otherwise innocent drivers become entangled in accidents caused by other drivers. Avoiding times when these accidents are most frequent can increase safety.

The analysis focuses on a specific location, US Highway 20 at Santiam Pass, a 4800 foot (1450 meters) mountain pass in the Cascade Range (milepost 79). As the main route from Bend, Oregon to the Willamette Valley cities of Portland, Eugene, and Salem, it has high traffic year round and is the site of [frequent](http://www.nuggetnews.com/archives/960717/front1.shtml) accidents. The specfici road condition analyzed is snow covered road surface. 

This analysis establishes the accident frequency and density for a 11 mile stretch of road to be correlation of snow and ice to traffic accidents on the pass. I show there is a high rate of accidents on the Pass (about one every two weeks). I use Bayesian analysis to show a high correlation to snowy road conditions. 


```{r "get_tweets", echo=FALSE, warning=FALSE}

##This program assumes you have already run the TwitterReader.R to download a feed timeline. 
##It reads the data in teh form of a .csv 

## Get the relevnat tweet data

        if (getwd()=="/Users/winstonsaunders/Documents") {setwd("TripcheckR")}
        file_name <- "TripCheckUS20B"

        hwy_df<-read.csv(paste0(file_name, ".csv"))

        ##make the date column a date
        hwy_df$created<-as.Date(hwy_df$created)

        ### define start adn edn times of period 
        tEnd <- hwy_df$created[length(hwy_df$created)]
        tStart <- hwy_df$created[1]
        


```

The data analyzed cover the dates from `r tEnd` to `r tStart`. There are `r dim(hwy_df)[1]` tweets during this period. 


```{r "clean", echo=FALSE, warning=FALSE}


        ##add meta table for correlation
        ## need to be insterted first
        metaincident <- "snow"
        ## get tweets with S2
        hwy_df2 <-hwy_df[grep(metaincident, hwy_df$text),]


        ##Define Search Patterns
        location <- "Santiam Pass Summit"
        ##Get tweets with S1
        hwy_df <-hwy_df[grep(location, hwy_df$text),]
        


        
        incident <- "crash"
        ## get tweets with S2
        hwy_df <-hwy_df[grep(incident, hwy_df$text),]
        
        

        

##dedup the data

        hwy_df<-hwy_df[!duplicated(hwy_df$created),]
        hwy_df2<-hwy_df2[!duplicated(hwy_df2$created),]

##analyze the hwy_df data

        ## get details on the crash from the text string

        ##Find "Mi" maker and then extract miles number
        
        midist<-lapply(hwy_df$text, function(x) {y<- regexpr("Mi", x)
                                                             if (y >4) substring(x,y-3,y-1)
                                                             else "NA"})
        
        distance<-as.numeric(midist)

        direction<-lapply(hwy_df$text, function(x) {y<- regexpr("Mi", x)
                                                             if (y >4) substring(x,y+2,y+3)
                                                             else "NA"})
        hwy_df$text<-substring(hwy_df$text,7,12)
        
        direction<-as.character(direction)

        ##bind new columns to data frame
        plotdata<-cbind(hwy_df, distance, direction )    

        ##reduce dimensions, keeping date, distance, and direction
        plotdata<-plotdata[,c(6,18,19)]

        ##filter for complete cases
        plotdata<-plotdata[complete.cases(plotdata), ]

        ##define function to strip spaces
        trim.leading <- function (x)  sub("^\\s+", "", x)

        plotdata$direction <- trim.leading(as.character(plotdata$direction))

        #Sign the distance based on direction

        for(i in 1:nrow(plotdata)) {if(plotdata$direction[i] =="E" | plotdata$direction[i] =="S") plotdata$distance[i] <- -1*plotdata$distance[i]}
                
           
## plot data 2

        plotdata2<-hwy_df2$created          ##keep only data column

##data are processed and ready to plot

        ##define a couple of variables for later use
        nAcc <- dim(plotdata)[1]
        nSnow <- length(plotdata2)

```


Filtering on the crtieria: _`r location`_  and _`r incident`_  and taking complete cases reduces the number of '`r incident` data points to `r nAcc`.   During the same period there were _`r nSnow`_ days with _`r metaincident`_. 

```{r "plot_the_data", echo=FALSE, fig.align='center', fig.width=8, fig.height=4}

##this section takes care of a formatting function to ensure the graph range starts on the first of a calendar month

##timeline(plotdata)

        rangeYM<- c(plotdata$created[dim(plotdata)[1]], plotdata$created[1])

        ##index graph to start on first of month
        # first decompose into components
        d<-as.POSIXlt(rangeYM[1])
        e<-unclass(d)
        # Then subract appropriate number of days 
        rangeYM[1]<-rangeYM[1]-e$mday+1

```

####summary statistics for the raw data

There were `r 7 * nrow(plotdata)/as.numeric((rangeYM[2]- rangeYM[1]))` accidents per week, meaning there is about one accident every two weeks when averaged over the entire record. Since the distance over which the accidents occured is the relatively short distance of `r max(plotdata$distance)-min(plotdata$distance)` miles, the accident density is `r 52*7 * nrow(plotdata)/as.numeric((rangeYM[2]- rangeYM[1]))/(max(plotdata$distance)-min(plotdata$distance))` accident/year/mile. 

During this period there were `r nSnow` days with snow reported on the road. The rest of this analysis will look at how this weather incident affects the accident rate. 

###Timeline of accidents

The graph below shows a timeline of accidents, with the location of the accident (measured in distance from the summit) represented by the y-axis. Red data points represent `r incident` data, while blue data points represent days when `r metaincident` was reported in the feed.


```{r, echo=FALSE, fig.align='center', fig.width=9  }

plot(NA,ylim=c(-10,10),xlim=rangeYM,ann=FALSE,axes=FALSE)

##manually draw axis and gridlines
abline(h=0,lwd=2,col="cornsilk4")
abline(h=2, lwd=1, col="cornsilk2")
abline(h=-2, lwd=1, col="cornsilk2")
abline(h=4, lwd=1, col="cornsilk2")
abline(h=-4, lwd=1, col="cornsilk2")
abline(h=6, lwd=1, col="cornsilk2")
abline(h=8, lwd=1, col="cornsilk2")

##define ypts as distance from summit
ypts <- plotdata$distance
##anchor line to x axis
y0pts2 <- rep_len(0, length.out=length(plotdata2))



y0pts <- rep_len(0, length.out=nrow(plotdata))
txtpts <- rep_len(c(1,3), length.out=nrow(plotdata))
ylblpts <- ypts
lblpts <- rep_len(c(3,1), length.out=nrow(plotdata))
segments(as.Date(plotdata$created),y0pts,as.Date(plotdata$created),ypts,col="cornsilk3")

##add y-axis numbers

axis(side=2, at=c(-4,-2,0,2,4,6,8), labels = c("-4 E", "-2 E", "0", "2 W", "4 W", "6 W", "8 W"), las=2, col="cornsilk4", lwd=2)

axis.Date(
 1,
 at=seq.Date(rangeYM[1],rangeYM[2],by="month"),
 format="%Y-%m",
 cex.axis=0.6,
 pos=0,
 lwd=0,
 lwd.tick=2,
 col="cornsilk4",
 font=1
)

points(plotdata$created,y=ypts, pch=20, cex=1.5, col="violetred2")
points(plotdata2, y = y0pts2, pch=19, cex=1, col="blue")

title(main=paste(location, file_name, "data", incident, "and", metaincident), ylab="distance from Summit (miles)")

##add x-axis text
text (rangeYM[1]+(rangeYM[2]-rangeYM[1])/2, -10, "date (yyyy-mm)")



```

###When do accidents occur?

We can also look at the correlation of accidents to the Day of Week. This correlation might be expected because traffic patterns change between weekdays and weekends.

```{r, echo=FALSE, fig.align='center', fig.height=3, fig.width=5}

##convert dates to weekedays using R utility
crashdays <- weekdays(as.Date(plotdata$created,'%Y-%m-%d'))
snowdays <- weekdays(as.Date(plotdata2,'%Y-%m-%d'))

##convert tables
cdt<-table(crashdays)
sdt<-table(snowdays)


cdt<-as.data.frame(cdt)
sdt<-as.data.frame(sdt)

cdt$crashdays<-factor(cdt$crashdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
sdt$snowdays<-factor(sdt$snowdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

library(ggplot2)

pp<-ggplot(data=cdt, aes(x=crashdays, y=Freq)) + geom_bar(colour="black",fill = "cornsilk4", stat="identity")
pp<-pp+ggtitle("Number of Crashes by Weekday")
pp<-pp+labs(x="Weekday", y="Number", title="Number of Crashes by Weekday")

pp

#ggplot(data=sdt, aes(x=snowdays, y=Freq)) + geom_bar(fill = "cornsilk4", stat="identity")

cdmean<-mean(cdt$Freq)
cdsd<-sd(cdt$Freq)

cdminzstat<-(min(cdt$Freq)- cdmean)/cdsd
cdmaxzstat<-(max(cdt$Freq)- cdmean)/cdsd


sdmean<-mean(sdt$Freq)
sdsd<-sd(sdt$Freq)

sdminzstat<-(min(sdt$Freq)- sdmean)/sdsd
sdmaxzstat<-(max(sdt$Freq)- sdmean)/sdsd

```

The above histrogram shows substantial variation depending on the day of the week. Friday, in this anlaysis has almost four times the number of accidents than Wednesday. The mean number of accidents per weekday is `r cdmean` and the standard deviation is `r cdsd`. The z-stat for the min is `r cdminzstat` and the max is `r cdmaxzstat`.

Parentetically, the number of snow days show no significant correlation to the weekday. This is what you'd expect, but it's a good check of the data. The mean number of snow days per weekday is `r sdmean`. For reference the z statistic for the min is `r sdminzstat` and the max is `r sdmaxzstat`.

Hence, the day of the week plays as substantial role in the number of accidents.


###Where do accidents occur?

This plot shows the distribution of accidents as measured by the distance from `r location`. In this specific case, while the number of accidents on the West side outweigh those on the East, there appears to be a strong bias to the distribution if one takes the mode as the center of the distribution.


```{r, echo=FALSE, fig.align='center', fig.height=3, fig.width=4}


hist(plotdata$distance, main=file_name,xlab="distance (E-W)", col = "deepskyblue2", xlim=c(-10,10), breaks=10)
```


The median distance of accidents is `r median(plotdata$distance)` Miles West of the Summit with a standard deviation of `r sd(plotdata$distance)` about the mean `r mean(plotdata$distance)`. The data show a skewed distribution. 

###How frequent are accidents when there is snow?

```{r, echo=FALSE}

tTotal <- as.numeric(tStart)-as.numeric(tEnd)

AccRate <- nAcc/tTotal
SnowRate<- nSnow/tTotal

```

We can calculate rough estimated of the accident rate `r AccRate` crashes per day and the probability of snow  `r SnowRate` per day during the same period.

```{r, echo=FALSE}

cd <- intersect(as.Date(plotdata$created), as.Date(plotdata2))


nCommon = length(cd)


nCommRate = nCommon/nSnow

```

With a little number crunching we find the probability that there was an accident given there was snow equal to (the number of days when there was snow and an accident) divided by (the number of days when there was snow) is `r nCommRate`. 
  
__That means that for roughly one in four days there is snow on the pass, there is an accident on this 11 mile stretch of road. __

If we looked at specfic weekdays, the rate would be even higher.


###Conclusions

Twitter data can be used to evaluate and predict road safety for the benefit of users.

The data here reveal several striking characteristics of this section of road.  
1. There is a very high accident rate, with `r 7 * nrow(plotdata)/as.numeric((rangeYM[2]- rangeYM[1]))` accidents per week.  
2. Since the distance over which the accidents occured is the relatively short distance (`r max(plotdata$distance)-min(plotdata$distance)` miles), the accident density  `r 52*7 * nrow(plotdata)/as.numeric((rangeYM[2]- rangeYM[1]))/(max(plotdata$distance)-min(plotdata$distance))` accident/year/mile is quite high.   
3. Drivers wanting to avoid accidents on the Pass, judging from the number of accidents, shoudl cross on Tuesday, Wednesday, Thursday, or Sunday. This is especially important if worried about someone crashing into you, since these days provide a factor of protection ranging from three to four.   
4. Establishing a correlation to the number of snow days, we find that there is an accident on this 11 miles stretch of road every four days there is snow there. 

